<!DOCTYPE html>
<html lang="en-us">

  <head>
  <meta charset="utf-8">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <title>Armv7m Startup (3) - Remote control via semihosting</title>
  <meta name="author" content="Martin Ribelotta" />
  
  
  
  
  <meta name="keywords" content="embedded, electronics, iot, make, gnu, Cortex-m, Microcontroller, ELF, ARM, Compiler">
  
  
  <meta name="description" content="ourEmbeddeds main site">

  <meta name="generator" content="Hugo 0.74.3" />

  
  <link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel='stylesheet' type='text/css'>

  
  <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.11.2/css/all.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  
  <link href="/css/animate.css" rel="stylesheet">

  
  
    <link href="/css/style.blue.css" rel="stylesheet" id="theme-stylesheet">
  

  
  <link href="/css/custom.css" rel="stylesheet">

  
  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png" />

  
  <link href="/css/owl.carousel.css" rel="stylesheet">
  <link href="/css/owl.theme.css" rel="stylesheet">

  
  <link rel="alternate" href="https://ourembeddeds.github.io/index.xml" type="application/rss+xml" title="Our Embeddeds">

  
  
  
  
  
  
  
  <meta property="og:locale" content="en_us">
  <meta property="og:site_name" content="Our Embeddeds">
  <meta property="og:title" content="Armv7m Startup (3) - Remote control via semihosting">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://ourembeddeds.github.io/blog/2020/11/02/armv7m-semihosting/" />
  <meta property="og:description" content="ourEmbeddeds main site">
  <meta property="og:image" content="https://ourembeddeds.github.io/img/articles/arm7m-semihosting/banner.jpg">
  <meta property="og:image:type" content="image/jpg">
  
  
  
    <meta property="og:image:width" content="2675">
    <meta property="og:image:height" content="2064">
  
  
  <meta property="og:updated_time" content="2020-11-02T13:25:55-0300">
  
    
    
    <meta property="article:section" content="Embedded">
    
    
    <meta property="article:published_time" content="2020-11-02T13:25:55-0300">
    <meta property="article:modified_time" content="2020-11-02T13:25:55-0300">
  

  
  <meta name="twitter:card" content="summary_large_image">
  
  <meta name="twitter:title" content="Armv7m Startup (3) - Remote control via semihosting">
  
  <meta name="twitter:image" content="https://ourembeddeds.github.io/img/articles/arm7m-semihosting/banner.jpg">
  
  <meta name="twitter:description" content="ourEmbeddeds main site">
  

</head>


  <body>

    <div id="all">

        <header class="navbar-affixed-top" data-spy="affix" data-offset-top="62">
    <div class="navbar navbar-default yamm" role="navigation" id="navbar">    
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand home" href="/">
                    <img src="/img/ourembeddeds-banner.png" alt="Armv7m Startup (3) - Remote control via semihosting logo" class="hidden-xs hidden-sm">
                    <img src="/img/logo-small.png" alt="Armv7m Startup (3) - Remote control via semihosting logo" class="visible-xs visible-sm">
                    <span class="sr-only">Armv7m Startup (3) - Remote control via semihosting - go to homepage</span>
                </a>
                <div class="navbar-buttons">
                    <button type="button" class="navbar-toggle btn-template-main" data-toggle="collapse" data-target="#navigation">
                      <span class="sr-only">Toggle Navigation</span>
                        <i class="fas fa-align-justify"></i>
                    </button>
                </div>
            </div>
            

            <div class="navbar-collapse collapse" id="navigation">
                <ul class="nav navbar-nav navbar-right">
                  
                  
                  
                  <li class="dropdown">
                    
                    <a href="/">Home</a>
                    
                  </li>
                  
                  
                  <li class="dropdown active">
                    
                    <a href="/blog/">Blog</a>
                    
                  </li>
                  
                  
                  <li class="dropdown">
                    
                    <a href="/contact/">Contact</a>
                    
                  </li>
                  
                </ul>
            </div>
            

            <div class="collapse clearfix" id="search">    
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">
                    <button type="submit" class="btn btn-template-main"><i class="fas fa-search"></i></button>
                </span>
                    </div>
                </form>
            </div>
            
        </div>
    </div>
</header>




        <div id="heading-breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>Armv7m Startup (3) - Remote control via semihosting</h1>
            </div>
        </div>
    </div>
</div>


        <div id="content">
            <div class="container">

                <div class="row">

                    

                    <div class="col-md-9" id="blog-post">

                        
                          <p class="text-muted text-uppercase mb-small text-right">
                            By <a href="#">Martin Ribelotta</a>
                             | 
                            November 2, 2020
                          </p>
                        

                        <div id="post-content">
                          <p>In this article, we communicate our embedded cortex-m with the PC during debug
session using a trick called semihosting. This trick provides access to host
IO (console, filesystem, shell execution) remotely from our embedded device.</p>
<div class="toc">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#debug-output-and-reason-to-do-via-semihosting">Debug output and reason to do via semihosting</a>
      <ul>
        <li><a href="#led-blinking-pwm-or-heart-beat-change-in-the-rhythm-of-blinking">Led blinking, PWM or heart beat (change in the rhythm of blinking)</a></li>
        <li><a href="#pin-move-and-catch-it-using-logic-analyzer">Pin move and catch it using logic analyzer</a></li>
        <li><a href="#serial-output">Serial output</a></li>
        <li><a href="#debug-channel-facilities">Debug channel facilities</a></li>
      </ul>
    </li>
    <li><a href="#semihosting-technical-background">Semihosting technical background</a></li>
    <li><a href="#the-concrete-armv7m-aka-cortex-m-semihosting">The concrete ARMv7M (aka cortex-m) semihosting</a></li>
    <li><a href="#another-history-risc-v-semihosting">Another history: RISC-V Semihosting</a></li>
    <li><a href="#semihosting-with-newlib-the-easy-way">Semihosting with newlib: The easy way</a>
      <ul>
        <li><a href="#rdimon-an-newlib-with-gcc">RDIMON an newlib with gcc</a></li>
        <li><a href="#using-previous-make-script">Using previous make script</a></li>
        <li><a href="#some-utilities-for-debugging">Some utilities for debugging</a></li>
        <li><a href="#some-security-warns">Some security warns</a></li>
        <li><a href="#last-idea-hardware-in-the-loop-verification">Last idea, hardware in the loop verification</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div>
<h2 id="debug-output-and-reason-to-do-via-semihosting">Debug output and reason to do via semihosting</h2>
<p>The most direct way to debug some embedded device is to produce a change in
observable output directly from code. Some techniques to do this will be:</p>
<h3 id="led-blinking-pwm-or-heart-beat-change-in-the-rhythm-of-blinking">Led blinking, PWM or heart beat (change in the rhythm of blinking)</h3>
<p>This technique is really easy to implement but the capable information to show
is very limited. In contrast, the resource consumption is quite small.</p>
<p><img src="/img/articles/arm7m-semihosting/altair.jpg" alt="led-debug"></p>
<h3 id="pin-move-and-catch-it-using-logic-analyzer">Pin move and catch it using logic analyzer</h3>
<p>Is a sophistication of the led blinking. This provides more accurate way to
show data from one or more pins. This need a logic analyzer and special
software to decode the signals.</p>
<p><img src="/img/articles/arm7m-semihosting/pv_decoders_2.png" alt="signal-debug"></p>
<h3 id="serial-output">Serial output</h3>
<p>Is an evolution of pin move. This technique move the pin in serial comm port
friendly way understandable for a common serial interface. This enable to send
any type of data. Normally, we wanna send an ascii plain text in human
readable way but we can implement some compression and use an special program
in the receiver side to show in human readable way. This is more expensive in
hardware (or programming if we decide emulate the serial in software) than the
simple pin movement but provides a more sophisticate interface.</p>
<p><img src="/img/articles/arm7m-semihosting/UART_Frame.svg" alt="uart-frame"></p>
<h3 id="debug-channel-facilities">Debug channel facilities</h3>
<p>Some debugger systems offer facilities to inspect memory and present the
contents in human readable way. By example, we can trigger a memory dump in
specific area when we encounter a breakpoint in the code, and produce,
programmatically these breakpoints after the inspectable memory region was
filled with your message.</p>
<p><img src="/img/articles/arm7m-semihosting/semihosting-debug.png" alt="semihosting-debug"></p>
<p>The last option is the root of semihosting techniques, not only for ARM, but
also for any architecture capable to be debugged and trigger a software
breakpoint, like MIPS, RISC-V, AVR, xtensa, nios, xcore, and virtually all
recently cores with integrated debugger</p>
<p>Semihosting technique have many advantages over other methods:</p>
<ul>
<li>we can use only one cable (the debugger cable)</li>
<li>we have access to many functions not only console print and write. Also,
using semihosting we can write and read files from your filesystem (with
permission from the user that actually runs the corresponding debug bridge
like openocd) or execute host binaries via <code>system</code> call</li>
<li>The interface and hardware involved is common to all platform independent
of your vendor (at least in cortex-m and risc-v). With cares, we can run the
same semihosting code in any cortex-m platform.</li>
</ul>
<p>But not all is good, some disadvantages appear if we chose this as debug
engine:</p>
<ul>
<li>When we have in system call (like write, read or printf) the processor is
halted until the host end to process the call. If we code is heavy time
dependant, may break your debug experience too much.</li>
<li>The call consume variable time depending of the power of host, the operation
requested and (firstly) the debug interface speed. Again, the call latency may
broke the system and invalidate your debug experience.</li>
<li>The amount of ram is quite small but normally, the semihosting is implemented
using libc like newlib or picolibc and these libraries may consume more than
simple led blinking.</li>
<li>we need a host connected to the device when your software is running.</li>
</ul>
<p>Having said that, the semihosting debug techniques is powerfully in many cases
and the potential problems can be avoided or mitigated with a careful debug
planning.</p>
<h2 id="semihosting-technical-background">Semihosting technical background</h2>
<p>The magic beside of semihosting is only the ability to inform to the debugger
in the host when the processor suffer a software interrupt enables to catch
using the hardware debugging system (half inner the CPU chip, half in the host
machine in form of software stack)</p>
<p><img src="/img/articles/arm7m-semihosting/semihosting-flow.png" alt="semihosting flow"></p>
<p>The steps was explained here:</p>
<ul>
<li>The device and the host are communicated via debug interface controlled, in
the host for the debug bridge (software like openocd, stlink or jlinkutils)
using some interface like JTAG, SWD, or other, normally in a form of
specialized hardware interface (usb to jtag chip, parallel port connection, or
other hardware that enable communication to the debug interface in the device)</li>
<li>These software pool the status of the device in regular periods and check the
CPU state for some special conditions triggered in semihosting call.</li>
<li>In the device, before we do semihost call, need to perform several actions:
<ul>
<li>Prepare a memory buffer with the corresponding data and configure the CPU
registers to point this data block. Normally, in other register we need to
put the system call number (an integer indicating the action to perform)</li>
<li>When the device environment is ready, the CPU perform an action that
trigger some hardware exceptions or interrupt that can be catch from the
debug subsystem internally on the chip. In cortex-m this imply a special
instruction called <code>bkpt #number</code> with an special value in <code>#number</code>. In
other architectures the action may imply trigger an interrupt or put some
special value in memory mapped register but the concept is the same. This
halt the CPU (or, at least the core that generate the exception)</li>
</ul>
</li>
<li>In the host, when the debug bridge detect the halt condition caused by a
debug exception, this software in the host read halted CPU state via debug
interface (JTAG, SWD, etc) and determine the type of call (print text, write
file, read file data, system call, etc). If the call need more data (like a
previous write buffer), the debug bridge read from the device to the host}
these data and use this to perform the requested action.</li>
<li>Now, with any required data copied from device to host, the debug bridge
perform the requested action. This may imply, write in screen, read from file
or standard input, get host system information or any function provided by the
debug bridge software. In some cases, the debug bridge software can communicate
with other software via socket or other inter process mechanism to delegate the
actions in specialized software or plugin.</li>
<li>When the host action is finished, the result of these action is packed and
sended to the device if required (not all semihost call need returned data).
The data is write in special buffer in the device via debug interface actions
and, finally, the halted CPU is resumed when the environment actualized.</li>
</ul>
<p>The semihosting action will be transparent for the device. This imply, by
example, when we perform a file read in semihosting mode, the behavior will be
exactly like a file read locally.</p>
<h2 id="the-concrete-armv7m-aka-cortex-m-semihosting">The concrete ARMv7M (aka cortex-m) semihosting</h2>
<p>The concrete implementation of semihosting in ARMv7M (aka cortex-m) is quite
simple. Only need to put the number of the call in r0 and the pointer to
parameters in r1. The number and type of parameter array is call dependent.
When the semihosting resume the CPU execution, a return code is put in r0.
If the host need to pass other information (like file data block) the function
call foresees a memory buffer pointer as an one of the parameters passed in the
array pointed by r1.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#999;font-style:italic">; file: sys_semihost.S 
</span><span style="color:#999;font-style:italic">; @csignature: int sys_semihost(int, void*)
</span><span style="color:#999;font-style:italic">; @brief: Semihosting call
</span><span style="color:#999;font-style:italic">; @param  [r0]: System call number
</span><span style="color:#999;font-style:italic">; @param  [r1]: Pointer to parameters
</span><span style="color:#999;font-style:italic">; @return [r0]: System call result
</span><span style="color:#999;font-style:italic"></span>sys_semihost:
	<span style="color:#447fcf">bkpt</span> <span style="color:#999;font-style:italic">#0xab
</span><span style="color:#999;font-style:italic"></span>	<span style="color:#40ffff">bx</span> <span style="color:#40ffff">lr</span>
</code></pre></div><p>we may call the code in your C/C++ program as:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#6ab825;font-weight:bold">extern</span> <span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">sys_semihost</span>(<span style="color:#6ab825;font-weight:bold">int</span> req, <span style="color:#6ab825;font-weight:bold">void</span> *args)

<span style="color:#6ab825;font-weight:bold">void</span> semihost_puts(<span style="color:#6ab825;font-weight:bold">const</span> <span style="color:#6ab825;font-weight:bold">char</span> *str)
{
	sys_semihost(<span style="color:#3677a9">0x04</span>, (<span style="color:#6ab825;font-weight:bold">void</span>*) str);
}
</code></pre></div><p>In this example, the function invoked is <code>SYS_WRITE0</code> with code <code>0x04</code>. This
function write a zero terminated string on stdout. The memory block containing
the zero terminated string is passed in r1 (the second parameter)</p>
<p>The return value is undefined and may be corrupted by the semihost operation.</p>
<p>An other example is the case of <code>open</code> syscall that open a file and return an
integer used by refer to these file in subsequent calls of <code>write</code> and <code>read</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;string.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>
<span style="color:#6ab825;font-weight:bold">extern</span> <span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">sys_semihost</span>(<span style="color:#6ab825;font-weight:bold">int</span> req, <span style="color:#6ab825;font-weight:bold">void</span> *args)

<span style="color:#6ab825;font-weight:bold">int</span> semihost_open(<span style="color:#6ab825;font-weight:bold">const</span> <span style="color:#6ab825;font-weight:bold">char</span> *name, <span style="color:#6ab825;font-weight:bold">const</span> <span style="color:#6ab825;font-weight:bold">char</span> *mode)
{
	<span style="color:#6ab825;font-weight:bold">int</span> params[] = {
		(<span style="color:#6ab825;font-weight:bold">int</span>) name, (<span style="color:#6ab825;font-weight:bold">int</span>) mode, strlen(mode)
	};
	<span style="color:#6ab825;font-weight:bold">return</span> sys_semihost(<span style="color:#3677a9">0x01</span>, params);
}
</code></pre></div><p>In this case, r0 contains the syscall code 0x1 corresponding to <code>SYS_OPEN</code>
function and r1 contain pointer to array of tree integers containing the
pointer to the file name at 0, the pointer of string mode at 1 and the size of
string mode in 2.</p>
<p>On finish, r0 contains an integer number representing the file descriptor for
refer the new opened file, or -1 in case of error.</p>
<p>A complete list of semihosting system calls and the required parameters can be
found in <a href="https://developer.arm.com/documentation/dui0471/g/Semihosting/Semihosting-operations?lang=en">armcc manual from arm site</a></p>
<h2 id="another-history-risc-v-semihosting">Another history: RISC-V Semihosting</h2>
<p>The semihosting technique is quite simple to implement. we only need a debug
capability in your processor, a little memory area of exchange, and a some
mechanism to catch with debugger.</p>
<p>For this, is not strange that practically all 32 or 64 bits architectures have
semihosting support. The rising RISC-V is not the exception.</p>
<p>In short, the treatment is much similar that ARM semihosting. The r0 and r1 is
replaced by x10 and x11 respectively (argument 0 and argument 1 in risc-v call
convention), and <code>BKPT</code> is replaced by hardware catchable instruction <code>EBREAK</code>.</p>
<p>Last but not least, <code>EBREAK</code> is not only for debug purpose, is the supervisor
call instruction and may be used in parallel for an embedded RTOS to
communicate user and kernel code. For this reason, the semihosting encode a tow
NOP instructions with special encoding in order to mark these particular
<code>EBREAK</code> occurrence for the debugger.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#999;font-style:italic">; file: sys_semihost.S 
</span><span style="color:#999;font-style:italic">; @csignature: int sys_semihost(int, void*)
</span><span style="color:#999;font-style:italic">; @brief: Semihosting call
</span><span style="color:#999;font-style:italic">; @param  [x10]: System call number
</span><span style="color:#999;font-style:italic">; @param  [x11]: Pointer to parameters
</span><span style="color:#999;font-style:italic">; @return [x10]: System call result
</span><span style="color:#999;font-style:italic"></span>sys_semihost:
    <span style="color:#447fcf">slli</span> <span style="color:#40ffff">x0</span>, <span style="color:#40ffff">x0</span>, <span style="color:#3677a9">0x1f</span>   <span style="color:#999;font-style:italic"># Entry NOP
</span><span style="color:#999;font-style:italic"></span>    <span style="color:#40ffff">ebreak</span>              <span style="color:#999;font-style:italic"># Break to debugger
</span><span style="color:#999;font-style:italic"></span>    <span style="color:#40ffff">srai</span> <span style="color:#40ffff">x0</span>, <span style="color:#40ffff">x0</span>, <span style="color:#3677a9">7</span>      <span style="color:#999;font-style:italic"># NOP encoding the semihosting call number 7
</span><span style="color:#999;font-style:italic"></span>	<span style="color:#40ffff">ret</span>
</code></pre></div><p>The corresponding documentation of this technique is found in
<a href="https://github.com/riscv/riscv-isa-manual/blob/master/src/rv32.tex#L1346">RISC-V ISA manual</a>
and is discuted in
<a href="https://github.com/riscv/riscv-debug-spec/pull/185">this RISC-V debug specification issue</a></p>
<h2 id="semihosting-with-newlib-the-easy-way">Semihosting with newlib: The easy way</h2>
<p>A minimal semihosting framework must be provide a console IO, file IO and not
so much more. Is not difficult to implement this using the above documents from
ARM and some little C and ASM code but the gcc arm embedded, and specifically
the libc bundled on it (newlib) provides many of the work with a funny and
familiar interface.</p>
<h3 id="rdimon-an-newlib-with-gcc">RDIMON an newlib with gcc</h3>
<p>Originally, RDIMON (remote debug interface) was a library bundled with ancient
ARM port of newlib as part of libgloss, a little piece of code dedicated to
implements the system dependent part of the newlib library (BTW, newlib is the
standard c library for embedded and resource constraint systems) implementing
the Angle software procedure call.</p>
<p>The original idea was the vendor provides a piece of code called monitor (maybe
in ROM or FLASH into board) and this catch the debug monitor interrupt making
the communication between the embedded device and software daemon in the host
system, normally, via serial, network or other system. This piece was baptized
by ARM as Angle debug monitor or ADB</p>
<p>With the advance of the technology, the monitor was replaced by dedicated
hardware called debug macrocell and the interface finally the communication to
the host transform in JTAG or SWD but the original idea work in same way, and
the name RDIMON for these library is maintained for compatibility.</p>
<p>These library was update with newer ARMv6 and ARMv7 debug interface enabling
modern semihosting interactions and many JTAG/SWD controllers like openocd
JLink or stlink software provides all of the interfaces specified in RDIMON
API.</p>
<p>By the way, the newlib bundled with gcc in <code>gcc arm embedded</code> distribution
(from ARM and others third part vendors) implements as a library all things
needed to use semihosting as a stdio output/input.</p>
<p>This imply that we use <code>printf/scanf</code> style C functions and show the result in
your debugger console (ok, sorry, in the output of your debug bridge like
openocd or jlink)</p>
<p>The arm gcc embedded distribution includes librdimon.a and librdimon_nano.a
out of the box (the first is the full fledged variant and the *_nano contain
the memory footprint reduced with limited functionality)</p>
<p>For use this, we only need to add the link flag to final phase:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">arm-none-eabi-gcc -o firmare.elf main.o other.o module.o -lc -lrdimon
</code></pre></div><p>Or for the nano version:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">arm-none-eabi-gcc -o firmare.elf main.o other.o module.o -lc_nano -lrdimon_nano
</code></pre></div><p>If we want gcc to automatically choose the correct library (nano or normal)
we need to use specs command:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">arm-none-eabi-gcc -o firmare.elf main.o other.o module.o -specs=rdimon.specs
</code></pre></div><p>The specs mechanism invoke a bundled specsfile (*.specs) that contains the
correct flags and some information to chose the right library version depending
of the previous linker flags. Additionally, specfiles contains some flags used
by the compiler (like some defines for check the configuration in your code)</p>
<h3 id="using-previous-make-script">Using previous make script</h3>
<p>In <a href="/blog/2020/09/30/armv7m-startup-make/">previous article</a> we make a generic
Makefile to build our project. This provides a way to add libraries for linker
scripts but not for add specfiles. To fix it, we need to add some capabilities
to handle specfiles:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Makefile" data-lang="Makefile"><span style="color:#40ffff">TARGET</span>=firmware
<span style="color:#40ffff">SOURCES</span>=<span style="color:#6ab825;font-weight:bold">$(</span>wildcard src/*.c<span style="color:#6ab825;font-weight:bold">)</span>
<span style="color:#40ffff">LIBPATH</span>=lib
<span style="color:#40ffff">LIBS</span>=
<span style="color:#40ffff">LDSCRIPTS</span>=link.ld
<span style="color:#40ffff">SPECS</span>=rdimon
<span style="color:#40ffff">OUT</span>=out

<span style="color:#999;font-style:italic"># ...more script...
</span><span style="color:#999;font-style:italic"></span>
<span style="color:#999;font-style:italic"># Linker flags
</span><span style="color:#999;font-style:italic"></span><span style="color:#40ffff">LDFLAGS</span>=<span style="color:#6ab825;font-weight:bold">$(</span>ARCH_FLAGS<span style="color:#6ab825;font-weight:bold">)</span>
<span style="color:#40ffff">LDFLAGS</span>+=-nostartfiles
<span style="color:#40ffff">LDFLAGS</span>+=<span style="color:#6ab825;font-weight:bold">$(</span>addprefix -L, <span style="color:#6ab825;font-weight:bold">$(</span>LIBPATH<span style="color:#6ab825;font-weight:bold">))</span>
<span style="color:#40ffff">LDFLAGS</span>+=<span style="color:#6ab825;font-weight:bold">$(</span>addprefix -l, <span style="color:#6ab825;font-weight:bold">$(</span>LIBS<span style="color:#6ab825;font-weight:bold">))</span>
<span style="color:#40ffff">LDFLAGS</span>+=<span style="color:#6ab825;font-weight:bold">$(</span>addprefix -T, <span style="color:#6ab825;font-weight:bold">$(</span>LDSCRIPTS<span style="color:#6ab825;font-weight:bold">))</span>
<span style="color:#40ffff">LDFLAGS</span>+=<span style="color:#6ab825;font-weight:bold">$(</span>addsuffix .specs, <span style="color:#6ab825;font-weight:bold">$(</span>addprefix -specs=, <span style="color:#6ab825;font-weight:bold">$(</span>SPECS<span style="color:#6ab825;font-weight:bold">)))</span>

<span style="color:#999;font-style:italic"># ...rest of code...
</span></code></pre></div><p>Now, we put this code in your main and can use semihosting printf in full
form:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>
<span style="color:#6ab825;font-weight:bold">extern</span> <span style="color:#6ab825;font-weight:bold">void</span> <span style="color:#447fcf">initialise_monitor_handles</span>(<span style="color:#6ab825;font-weight:bold">void</span>);

<span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">main</span>()
{
    initialise_monitor_handles(); <span style="color:#999;font-style:italic">/* Need for internal initialization */</span>
    printf(<span style="color:#ed9d13">&#34;Hello world</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>);
    printf(<span style="color:#ed9d13">&#34;Compiled with %s</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, __VERSION__);
    printf(<span style="color:#ed9d13">&#34;At %s %s</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, __DATE__, __TIME__);
    <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#3677a9">0</span>;
}
</code></pre></div><p>We can run <code>program</code> to flash the MCU but the best way to show the program
running is to put the <code>openocd</code> in semihosting mode and run the program without
exiting.</p>
<p>For this we need to add this rule to <code>Makefile</code></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Makefile" data-lang="Makefile"><span style="color:#999;font-style:italic"># ...openocd flag sections...
</span><span style="color:#999;font-style:italic"></span><span style="color:#40ffff">OOCD_FLAGS</span>:=-f interface/stlink.cfg -f target/stm32f1x.cfg

<span style="color:#40ffff">OOCD_CMDS</span>:=-c <span style="color:#ed9d13">&#34;init&#34;</span>
<span style="color:#40ffff">OOCD_CMDS</span>+=-c <span style="color:#ed9d13">&#34;reset halt&#34;</span>
<span style="color:#40ffff">OOCD_CMDS</span>+=-c <span style="color:#ed9d13">&#34;program </span><span style="color:#6ab825;font-weight:bold">$(</span>TARGET_ELF<span style="color:#6ab825;font-weight:bold">)</span><span style="color:#ed9d13"> verify reset exit&#34;</span>

<span style="color:#40ffff">OOCD_RUN_CMDS</span>:=-c <span style="color:#ed9d13">&#34;init&#34;</span>
<span style="color:#40ffff">OOCD_RUN_CMDS</span>+=-c <span style="color:#ed9d13">&#34;reset halt&#34;</span>
<span style="color:#40ffff">OOCD_RUN_CMDS</span>+=-c <span style="color:#ed9d13">&#34;program </span><span style="color:#6ab825;font-weight:bold">$(</span>TARGET_ELF<span style="color:#6ab825;font-weight:bold">)</span><span style="color:#ed9d13"> verify&#34;</span>
<span style="color:#40ffff">OOCD_RUN_CMDS</span>+=-c <span style="color:#ed9d13">&#34;reset halt&#34;</span>
<span style="color:#40ffff">OOCD_RUN_CMDS</span>+=-c <span style="color:#ed9d13">&#34;arm semihosting enable&#34;</span>
<span style="color:#40ffff">OOCD_RUN_CMDS</span>+=-c <span style="color:#ed9d13">&#34;resume&#34;</span>

<span style="color:#447fcf">program</span>: <span style="color:#6ab825;font-weight:bold">$(</span><span style="color:#40ffff">TARGET_ELF</span><span style="color:#6ab825;font-weight:bold">)</span>
	<span style="color:#6ab825;font-weight:bold">$(</span>Q<span style="color:#6ab825;font-weight:bold">)$(</span>OOCD<span style="color:#6ab825;font-weight:bold">)</span> <span style="color:#6ab825;font-weight:bold">$(</span>OOCD_FLAGS<span style="color:#6ab825;font-weight:bold">)</span> <span style="color:#6ab825;font-weight:bold">$(</span>OOCD_CMDS<span style="color:#6ab825;font-weight:bold">)</span>

<span style="color:#447fcf">run</span>: <span style="color:#6ab825;font-weight:bold">$(</span><span style="color:#40ffff">TARGET_ELF</span><span style="color:#6ab825;font-weight:bold">)</span>
	<span style="color:#6ab825;font-weight:bold">$(</span>Q<span style="color:#6ab825;font-weight:bold">)$(</span>OOCD<span style="color:#6ab825;font-weight:bold">)</span> <span style="color:#6ab825;font-weight:bold">$(</span>OOCD_FLAGS<span style="color:#6ab825;font-weight:bold">)</span> <span style="color:#6ab825;font-weight:bold">$(</span>OOCD_RUN_CMDS<span style="color:#6ab825;font-weight:bold">)</span>

</code></pre></div><p>Now, we run the software using <code>make run</code>, this program the target, and start
openocd and the result may be similar to this:</p>
<pre><code>$&gt; make run
xPack OpenOCD, 64-bit Open On-Chip Debugger 0.10.0+dev (2019-07-17-11:25)
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
debug_level: 0

target halted due to debug-request, current mode: Thread 
xPSR: 0x01000000 pc: 0x08000088 msp: 0x20005000
target halted due to debug-request, current mode: Thread 
xPSR: 0x01000000 pc: 0x08000088 msp: 0x20005000
** Programming Started **
** Programming Finished **
** Verify Started **
** Verified OK **
target halted due to debug-request, current mode: Thread 
xPSR: 0x01000000 pc: 0x08000088 msp: 0x20005000
semihosting is enabled

---------------------------------------------------
Hello world
Compiled with 9.2.1 20191025 (release) [ARM/arm-9-branch revision 277599]
At Nov  9 2020 12:54:14
</code></pre><p>we can peek <a href="https://gist.github.com/martinribelotta/06f8a4d43286933902e27da4fd80d810">the complete makefile from here</a>:</p>
<script type="application/javascript" src="https://gist.github.com/martinribelotta/06f8a4d43286933902e27da4fd80d810.js"></script>

<h3 id="some-utilities-for-debugging">Some utilities for debugging</h3>
<p>Semihosting enables very interesting posibilities like automatic memory dump in
failure or testbench execution over hardware in the loop.</p>
<p>By example, this simplest programm dump entire memory suposing this start at
<code>0x20000000</code> and have <code>8K</code> bytes.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>
<span style="color:#6ab825;font-weight:bold">extern</span> <span style="color:#6ab825;font-weight:bold">void</span> <span style="color:#447fcf">initialise_monitor_handles</span>(<span style="color:#6ab825;font-weight:bold">void</span>);

<span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">main</span>() {
    initialise_monitor_handles();
    FILE *fd = fopen(<span style="color:#ed9d13">&#34;memory.bin&#34;</span>, <span style="color:#ed9d13">&#34;wt&#34;</span>);
    <span style="color:#6ab825;font-weight:bold">if</span> (fd) {
        <span style="color:#6ab825;font-weight:bold">if</span> (fwrite((<span style="color:#6ab825;font-weight:bold">void</span>*) <span style="color:#3677a9">0x20000000</span>, <span style="color:#3677a9">8192</span>, <span style="color:#3677a9">1</span>, fd) == -<span style="color:#3677a9">1</span>) {
            perror(<span style="color:#ed9d13">&#34;writing memory.bin&#34;</span>);
        } <span style="color:#6ab825;font-weight:bold">else</span>
            puts(<span style="color:#ed9d13">&#34;Memory dump end ok&#34;</span>);
        fclose(fd);
    } <span style="color:#6ab825;font-weight:bold">else</span>
        perror(<span style="color:#ed9d13">&#34;open memory.bin&#34;</span>);
    <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#3677a9">0</span>;
}
</code></pre></div><p>Or this other that send a previos prepared data file to the serial port at:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>
<span style="color:#999;font-style:italic">// GPIO address
</span><span style="color:#999;font-style:italic"></span><span style="color:#cd2828;font-weight:bold">#define OUT (*((volatile unsigned int*)0xE0001C00))
</span><span style="color:#cd2828;font-weight:bold"></span>
<span style="color:#6ab825;font-weight:bold">extern</span> <span style="color:#6ab825;font-weight:bold">void</span> <span style="color:#447fcf">initialise_monitor_handles</span>(<span style="color:#6ab825;font-weight:bold">void</span>);

<span style="color:#6ab825;font-weight:bold">static</span> <span style="color:#6ab825;font-weight:bold">char</span> buffer[<span style="color:#3677a9">512</span>];

<span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">main</span>() {
    initialise_monitor_handles();
    <span style="color:#999;font-style:italic">// You need to initialize GPIO here
</span><span style="color:#999;font-style:italic"></span>    FILE *fd = fopen(<span style="color:#ed9d13">&#34;data.bin&#34;</span>, <span style="color:#ed9d13">&#34;rb&#34;</span>);
    <span style="color:#6ab825;font-weight:bold">if</span> (fd) {
        <span style="color:#6ab825;font-weight:bold">while</span> (!feof(fd)) {
            <span style="color:#6ab825;font-weight:bold">int</span> readed = fread(buffer, <span style="color:#6ab825;font-weight:bold">sizeof</span>(buffer), <span style="color:#3677a9">1</span>, fd);
            <span style="color:#6ab825;font-weight:bold">for</span> (<span style="color:#6ab825;font-weight:bold">int</span> i=<span style="color:#3677a9">0</span>; i&lt;readed; i++)
                OUT = buffer[i];
        }
        fclose(fd);
    } <span style="color:#6ab825;font-weight:bold">else</span>
        perror(<span style="color:#ed9d13">&#34;open memory.bin&#34;</span>);
    <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#3677a9">0</span>;
}
</code></pre></div><h3 id="some-security-warns">Some security warns</h3>
<p>Semihosting is a good tool to work with this, but imply some security risks to
concider. Semihosting have entire control of your filesystem, at least with the
permission that openocd (or similar software) is running, and, at least
teorically your firmware can create, remove or rename any files in the
filesystem area where openocd have permission.</p>
<p>Some scenarios of risk is:</p>
<ul>
<li>On windows, you can access any location in your filesystem. Take care with it
if your semihosting write or rename some files</li>
<li>The <code>system</code> call provides remote execution of any script or binary in the
security ring where openocd is execute</li>
<li>The function <code>unlink</code> is really harmfull, you can remove any file without
confirmation or prevention if openocd have permission of write over it</li>
<li>The <code>open/write</code> pair of functions need to take care for the place to write.
If you wanna put <code>/tmp/</code> is a secure place to do, and more scure is usage of
<code>tmpname</code> function for retrieve a secure filename in secure place.</li>
</ul>
<p>All of these errors may be avoided executing openocd with correct permissions
but this is not possible in all operating systems.</p>
<h3 id="last-idea-hardware-in-the-loop-verification">Last idea, hardware in the loop verification</h3>
<p>Embedded design and testing is hard, varios order of magnitude more hard than
an entire PC based software, because the behavior is dependent on many external
conditions and generate varios external observable events.</p>
<p>During the development process, you may require to prove your engine with the
real board connected to the system generating specific events in the input and
sensing specific behavior in the output.</p>
<p>Normally, this process invole some technical equipment and one or more humans
due to run the procedure manually. This is expensive and error prone, in vast
majority of cases via human errors.</p>
<p>The ideal way of co-verification of software-firmware-hardware is an automated
test with an special mount using debugger PC, signal generators, data
adquisition systems and some scripts to automatize the process.</p>
<p>In this scenario, the semihosting can help too much controlling entire process
via the firmware in the device.</p>
<p><img src="/img/articles/arm7m-semihosting/hw-in-the-loop.png" alt="hardware in the loop"></p>
<p>This technique is quite amplious and require own article, but the idea is very
powerfull and enables continuous integration for complex hardware.</p>
<p>We read in the following article</p>
                        </div>
                        
                        

                    </div>
                    

                    

                    

                    <div class="col-md-3">

                        

                        

<div class="panel panel-default sidebar-menu">

    <div class="panel-heading">
      <h3 class="panel-title">Search</h3>
    </div>

    <div class="panel-body">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" role="search">
            <div class="input-group">
                <input type="search" name="q" class="form-control" placeholder="Search">
                <input type="hidden" name="sitesearch" value="https://ourembeddeds.github.io/">
                <span class="input-group-btn">
                    <button type="submit" class="btn btn-template-main"><i class="fas fa-search"></i></button>
                </span>
            </div>
        </form>
    </div>
</div>







<div class="panel panel-default sidebar-menu">

    <div class="panel-heading">
        <h3 class="panel-title">Categories</h3>
    </div>

    <div class="panel-body">
        <ul class="nav nav-pills nav-stacked">
            
            
            <li>
                <a href="/categories/arm">arm (5)</a>
            </li>
            
            <li>
                <a href="/categories/embedded">embedded (5)</a>
            </li>
            
            <li>
                <a href="/categories/institutional">institutional (1)</a>
            </li>
            
            <li>
                <a href="/categories/make">make (2)</a>
            </li>
            
            <li>
                <a href="/categories/microcontrollers">microcontrollers (5)</a>
            </li>
            
            <li>
                <a href="/categories/semihosting">semihosting (1)</a>
            </li>
            
        </ul>
    </div>

</div>













                        

                    </div>
                    

                    

                </div>
                

            </div>
            
        </div>
        

        <footer id="footer">
    <div class="container">

        
        <div class="col-md-4 col-sm-6">
            <h4>About us</h4>

            <p>Embedded developers professional group.</p>

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

        <div class="col-md-4 col-sm-6">

             
            <h4>Recent posts</h4>

            <div class="blog-entries">
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://ourembeddeds.github.io/blog/2020/11/02/armv7m-semihosting/">
                          
                            <img src="/img/articles/arm7m-semihosting/banner.jpg" class="img-responsive" alt="Armv7m Startup (3) - Remote control via semihosting">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://ourembeddeds.github.io/blog/2020/11/02/armv7m-semihosting/">Armv7m Startup (3) - Remote control via semihosting</a></h5>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://ourembeddeds.github.io/blog/2020/09/30/armv7m-startup-make/">
                          
                            <img src="/img/articles/armv7m-boot-3/self-made-man.png" class="img-responsive" alt="Armv7m Startup (3) - Make and build process">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://ourembeddeds.github.io/blog/2020/09/30/armv7m-startup-make/">Armv7m Startup (3) - Make and build process</a></h5>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://ourembeddeds.github.io/blog/2020/09/21/arm7m-startup-ldscript/">
                          
                            <img src="/img/articles/armv7m-boot/chinece-ancient-kanji.png" class="img-responsive" alt="Armv7m Startup (2) - Linker script">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://ourembeddeds.github.io/blog/2020/09/21/arm7m-startup-ldscript/">Armv7m Startup (2) - Linker script</a></h5>
                    </div>
                </div>
                
            </div>

            <hr class="hidden-md hidden-lg">
             

        </div>
        

        
        <div class="col-md-4 col-sm-6">

          <h4>Contact</h4>

            <p class="text-uppercase"><strong>Bariloche</strong>
        <br>Vte O'Connor 647
        <br>Floor 5, Box 2
        <br>Rio Negro
        <br>
        <strong>Argentina</strong>
      </p>
      

            <a href="/contact" class="btn btn-small btn-template-main">Go to contact page</a>

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

    </div>
    
</footer>







<div id="copyright">
    <div class="container">
        <div class="col-md-12">
            
            <p class="pull-left">Copyright (c) 2020, OurEmbeddeds; all rights reserved.</p>
            
            <p class="pull-right">
              Template by <a href="https://bootstrapious.com/p/universal-business-e-commerce-template">Bootstrapious</a>.
              

              Ported to Hugo by <a href="https://github.com/devcows/hugo-universal-theme">DevCows</a>.
            </p>
        </div>
    </div>
</div>





    </div>
    

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-177396015-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

<script src="//code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>

<script src="/js/front.js"></script>


<script src="/js/owl.carousel.min.js"></script>



  </body>
</html>
